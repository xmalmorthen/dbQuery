const $usersObj={vars:{forms:{frmAddUsers:null},tables:{tblUsers:{dom:null,obj:null}},status:{userSaved:!1}},fncs:{init:async()=>{$(".page-link").addClass("btn btn-outline-secondary btn-sm"),$usersObj.vars.forms.frmAddUsers=$("#frmAddUsers"),$usersObj.vars.tables.tblUsers.dom=$("#tblUsers"),$usersObj.vars.tables.tblUsers.obj=$usersObj.vars.tables.tblUsers.dom.on("preInit.dt",(e,s)=>{$usersObj.vars.tables.tblUsers.dom.LoadingOverlay("show")}).DataTable({columnDefs:[{targets:"_all",className:"px-1"},{targets:[4],orderable:!1}],initComplete:function(e,s){$("#table_wrapper .row:eq(1)").attr("style","overflow-x: auto;"),$usersObj.vars.tables.tblUsers.dom.LoadingOverlay("hide")}}),$("#addUserSection").on("shown.bs.collapse",$usersObj.fncs.tab.users.collapseShown).on("show.bs.collapse",$usersObj.fncs.tab.users.collapseShow).on("hide.bs.collapse",$usersObj.fncs.tab.users.collapseHide),$(".saveUser").on("click",$usersObj.fncs.tab.users.saveUser),$.validator.addMethod("confirmPassword",function(e,s){return e==$("#password").val()},"La contraseña no coincide."),$.fn.select2.defaults.set("language","es"),$(".select2Cmb").select2({width:"100%"}),$usersObj.fncs.tab.users.refresh.tableUsers()},resetForm:e=>{e.validate().resetForm(),e.find(".text-danger").html(""),e.closeAlert({alertType:"alert-danger"}),e.trigger("reset")},changeFrm:function(){$__this=$(this),$__this.data("changed",!0)},tab:{users:{collapseShow:async()=>{const e=$usersObj.vars.forms.frmAddUsers,s=$("#idPerson"),a=$("#roles");try{e.find("input, select").data("changed",!1).unbind($usersObj.fncs.changeFrm)}catch(e){}e.find("input, select").on("change",$usersObj.fncs.changeFrm),$usersObj.fncs.tab.users.populate.cmbPerson(s,e).then(),$usersObj.fncs.tab.users.populate.cmbRoles(a,e).then()},collapseShown:()=>{$usersObj.fncs.resetForm($usersObj.vars.forms.frmAddUsers),$usersObj.vars.status.userSaved=!1,$("#username").focus(),document.location.href="#addUserSection"},collapseHide:async function(e){const s=$(this);if(e.preventDefault(),$__promiseResponse=await new Promise(e=>{$__changed=!1,$usersObj.vars.forms.frmAddUsers.find("input, select").each((s,a)=>{$(a).data("changed")&&e(!0)}),e(!1)}),0==$__promiseResponse)return s.off("hide.bs.collapse",$usersObj.fncs.tab.users.collapseHide).collapse("hide").on("hide.bs.collapse",$usersObj.fncs.tab.users.collapseHide),!1;if(!$usersObj.vars.status.userSaved){if(Swal.isVisible())return!1;const e=await Swal.fire({title:"Registro",text:"¿Ocultar sin registrar el usuario?",footer:"Si acepta se perderán los datos no registrados",icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Si",cancelButtonText:"No",backdrop:!0,allowOutsideClick:!1});if(e.dismiss)return!1}s.off("hide.bs.collapse",$usersObj.fncs.tab.users.collapseHide).collapse("hide").on("hide.bs.collapse",$usersObj.fncs.tab.users.collapseHide),$usersObj.fncs.resetForm($usersObj.vars.forms.frmAddUsers)},refresh:{tableUsers:async()=>{$usersObj.fncs.tab.users.populate.tableUsers($usersObj.vars.tables.tblUsers.obj,await $usersObj.fncs.tab.users.getUsers($("#usersTab .tableSection")))},cmbPerson:async(e,s=null)=>{const a=e,r=$usersObj.vars.forms.frmAddUsers,t=s||a.val();t?(await $usersObj.fncs.tab.users.populate.cmbPerson(a,r),a.val(t).trigger("change")):$usersObj.fncs.tab.users.populate.cmbPerson(a,r)},cmbRol:async(e,s=null)=>{const a=e,r=$usersObj.vars.forms.frmAddUsers,t=s||a.val();t?(await $usersObj.fncs.tab.users.populate.cmbRoles(a,r),a.val(t).trigger("change")):$usersObj.fncs.tab.users.populate.cmbPerson(a,r)}},populate:{cmbPerson:async(e,s)=>{const a=s,r=e,t=r.parent().find(".select2 .select2-selection").length>0?r.parent().find(".select2 .select2-selection"):r;r.prop("disabled",!0),r.find("option").remove(),r.append('<option disabled selected value><i class="fa fa-refresh fa-spin fa-3x fa-fw"></i> Actualizando, favor de esperar...</option>');try{if($__promise=await $.genericAjaxPromise({ajax:{type:"POST",url:`${siteUrl}Catalogs/ajaxPersons`,data:{csrf_QUERY:csrf.hash},headers:{}},loadingOverlayObj:t}).catch(function(e){return e}),!$ajaxResponse.check($__promise))throw $__promise}catch(e){$exception._throw(e,a),r.find("option").remove(),r.setError("ERROR al actualizar")}return r.find("option").remove(),r.append("<option disabled selected value>Seleccione una opción</option>"),new Promise(e=>{let s=$__promise.data.length;$__promise.data.forEach(a=>{const t=`${a.nombres} ${a.ap1} ${a.ap2?a.ap2:""}`.trim(),n=new Option(t,a.id);r.append(n),s--,0==s&&(r.prop("disabled",!1),e(!0))})})},cmbRoles:async(e,s)=>{const a=s,r=e,t=r.parent().find(".select2 .select2-selection").length>0?r.parent().find(".select2 .select2-selection"):r;r.prop("disabled",!0),r.find("option").remove();try{if($__promise=await $.genericAjaxPromise({ajax:{type:"POST",url:`${siteUrl}Catalogs/ajaxRoles`,data:{csrf_QUERY:csrf.hash,model:"active=1"},headers:{}},loadingOverlayObj:t}).catch(function(e){return e}),!$ajaxResponse.check($__promise))throw $__promise}catch(e){$exception._throw(e,a),r.find("option").remove(),r.setError("ERROR al actualizar")}return new Promise(e=>{let s=$__promise.data.length;$__promise.data.forEach(a=>{const t=new Option(a.rol,a.id);r.append(t),s--,0==s&&(r.prop("disabled",!1),e(!0))})})},tableUsers:async(e,s)=>{if(!s)return null;const a=$("#"+e.table().context[0].sTableId);try{e.clear().draw(),$.each(s,function(s,a){let r=`<a href="#" class="btn btn-outline-primary btn-sm mx-1 detailUser"     title="Detalle"><i class="fa fa-address-card-o"  aria-hidden="true"></i></a>\n                                     ${checkRole(["super","admin"])?'<a href="#" class="btn btn-outline-primary btn-sm mx-1 editUser"       title="Editar" ><i class="fa fa-pencil-square-o" aria-hidden="true"></i></a>':""}\n                                     ${a.id!=user.user.id&&checkRole(["super","admin"])?`<a href="#" class="btn btn-outline-${"1"===a.userActive?"danger":"primary"} btn-sm mx-1 activeInactive" title="${"1"===a.userActive?"Desactivar":"Activar"}" data-action='${"1"===a.userActive?0:1}' ><i class="fa fa-${"1"===a.userActive?"times-circle-o":"check-circle-o"}" aria-hidden="true"></i></a>`:""}`,t="";$.each(a.roles,(e,s)=>{t+=s.rol+(e<a.roles.length-1?" | ":"")});const n=[a.userName,(a.nombres+" "+a.ap1+" "+(a.ap2?a.ap2:"")).trim(),'<i class="fa fa-'+("1"===a.userActive?"check-circle-o":"times-circle-o")+' fa-2x fa-fw" aria-hidden="true"></i><span class="pl-2">'+("1"===a.userActive?"si":"no")+"</span>",moment(a.fIns).format("DD/MM/YYYY"),t.length>0?t:"Sin rol asignado.",r],o=e.row.add(n).draw().node();"0"===a.userActive&&$(o).addClass("bg-danger-alpha"),$(o).find("td:eq(2)").data("order","1"===a.userActive?"si":"no"),$(o).find("td:last").addClass("actions"),$(o).prop("id",a.keyid),$(o).data("model",btoa(JSON.stringify(a)))}),e.columns.adjust().responsive.recalc(),$(".detailUser").off("click",$usersObj.fncs.tab.users.detailUser).on("click",$usersObj.fncs.tab.users.detailUser),$(".editUser").off("click",$usersObj.fncs.tab.users.edituser).on("click",$usersObj.fncs.tab.users.editUser),$(".activeInactive").off("click",$usersObj.fncs.tab.users.activeInactive).on("click",$usersObj.fncs.tab.users.activeInactive);const r=$($usersObj.vars.tables.tblUsers.obj.table().container()).find(".row:first");0==r.find(".refreshTable").length&&r.append("<div class='col-12 text-left'><a href='#' class='refreshTable btn btn-outline-secondary btn-sm' role='button' onclick='$usersObj.fncs.tab.users.refresh.tableUsers(); return false;' title='Actualizar lista'><i class='fa fa-refresh fa-2x' aria-hidden='true'></i></a></div>")}catch(e){$exception._throw(e,a)}}},addPerson:async()=>{const e=$("#frmAddPerson");try{e.find("input, select").data("changed",!1).unbind($usersObj.fncs.changeFrm)}catch(e){}e.find("input, select").on("change",$usersObj.fncs.changeFrm),Swal.mixin({customClass:{confirmButton:"btn btn-outline-success mx-1",cancelButton:"btn btn-outline-danger mx-1"},buttonsStyling:!1}).fire({html:$("#sectionAddPerson").html(),focusConfirm:!1,backdrop:!0,allowOutsideClick:!1,confirmButtonText:'<i class="fa fa-floppy-o" aria-hidden="true"></i> Registrar',showCancelButton:!0,cancelButtonText:'<i class="fa fa-times" aria-hidden="true"></i> Cancelar',width:window.matchMedia("(max-width: 960px)").matches?"95vw":"50vw",showLoaderOnConfirm:!0,showClass:{popup:"animated fadeInDown faster"},hideClass:{popup:"animated fadeOutUp faster"},onBeforeOpen:async()=>{const e=Swal.getContent().querySelector("#frmAddPerson");$(e).addClass("text-left")},preConfirm:async e=>{const s=Swal.getContent().querySelector("#frmAddPerson"),a=await $usersObj.actions.addPerson($(s));return a||!1}}).then(e=>{e.value&&$usersObj.fncs.tab.users.refresh.cmbPerson($("#idPerson"),e.value)})},addRol:async()=>{const e=$("#frmAddRol");try{e.find("input, select").data("changed",!1).unbind($usersObj.fncs.changeFrm)}catch(e){}e.find("input, select").on("change",$usersObj.fncs.changeFrm),Swal.mixin({customClass:{confirmButton:"btn btn-outline-success mx-1",cancelButton:"btn btn-outline-danger mx-1"},buttonsStyling:!1}).fire({html:$("#sectionAddRol").html(),focusConfirm:!1,backdrop:!0,allowOutsideClick:!1,confirmButtonText:'<i class="fa fa-floppy-o" aria-hidden="true"></i> Registrar',showCancelButton:!0,cancelButtonText:'<i class="fa fa-times" aria-hidden="true"></i> Cancelar',width:window.matchMedia("(max-width: 960px)").matches?"95vw":"50vw",showLoaderOnConfirm:!0,showClass:{popup:"animated fadeInDown faster"},hideClass:{popup:"animated fadeOutUp faster"},onBeforeOpen:async()=>{const e=Swal.getContent().querySelector("#frmAddRol");$(e).addClass("text-left")},preConfirm:async e=>{const s=Swal.getContent().querySelector("#frmAddRol"),a=await $usersObj.actions.addRol($(s));return a||!1}}).then(e=>{e.value&&$usersObj.fncs.tab.users.refresh.cmbRol($("#roles"),e.value)})},saveUser:async()=>{const e=await $usersObj.fncs.tab.users.save();if(!e)return!1;$usersObj.fncs.tab.users.refresh.tableUsers(),$("#addUserSection").collapse("hide"),$usersObj.fncs.resetForm($usersObj.vars.forms.frmAddUsers)},getUsers:async e=>{let s=null;try{if($__promise=await $usersObj.actions.getUsers(e).catch(function(e){return e}),!$ajaxResponse.check($__promise))throw $__promise;s=$__promise.data}catch(s){$exception._throw(s,e)}return s},detailUser:async function(e){e.preventDefault();const s=JSON.parse(atob($(this).closest("tr").data("model")));$("#sectionDetailUser .idData").html(s.id),$("#sectionDetailUser .userData").html(s.userName),$("#sectionDetailUser .nameData").html((s.nombres+" "+s.ap1+" "+(s.ap2?s.ap2:"")).trim()),$("#sectionDetailUser .dateInsertData").html(moment(s.fIns).format("DD/MM/YYYY")),$("#sectionDetailUser .activeData").html('<i class="fa fa-'+("1"===s.userActive?"check-circle-o":"times-circle-o")+' fa-2x" aria-hidden="true"></i>'),Swal.fire({html:$("#sectionDetailUser").html(),focusConfirm:!1,backdrop:!0,allowOutsideClick:!1,confirmButtonText:"Cerrar",width:window.matchMedia("(max-width: 960px)").matches?"95vw":"50vw"})},editUser:async function(e){e.preventDefault();const s=JSON.parse(atob($(this).closest("tr").data("model")));Swal.mixin({customClass:{confirmButton:"btn btn-outline-success mx-1",cancelButton:"btn btn-outline-danger mx-1"},buttonsStyling:!1}).fire({html:$("#sectionEditUser").html(),focusConfirm:!1,backdrop:!0,allowOutsideClick:!1,confirmButtonText:'<i class="fa fa-floppy-o" aria-hidden="true"></i> Editar',showCancelButton:!0,cancelButtonText:'<i class="fa fa-times" aria-hidden="true"></i> Cancelar',width:window.matchMedia("(max-width: 960px)").matches?"95vw":"50vw",showLoaderOnConfirm:!0,showClass:{popup:"animated fadeInDown faster"},hideClass:{popup:"animated fadeOutUp faster"},onBeforeOpen:async()=>{Swal.showLoading();const e=$(Swal.getContent().querySelector("#frmEditUser")),a=$(e).find("#rolesE");$usersObj.fncs.resetForm(e),e.find("#idUserUpdate").val(s.id);try{e.find("input, select").data("changed",!1).unbind($usersObj.fncs.changeFrm)}catch(e){}e.find("input, select").on("change",$usersObj.fncs.changeFrm),e.addClass("text-left"),$.validator.addMethod("confirmPasswordE",function(s,a){return s==e.find("#passwordE").val()},"La contraseña no coincide."),a.select2({width:"100%"}),a.prop("required",!0),e.find(".btnRefreshCmbRolE").on("click",e=>{e.preventDefault(),$usersObj.fncs.tab.users.refresh.cmbRol(a)}),await $usersObj.fncs.tab.users.populate.cmbRoles(a,e),a.val(s.roles.map(e=>e.idCaRol)).trigger("change.select2"),Swal.hideLoading()},preConfirm:async e=>{const s=$(Swal.getContent().querySelector("#frmEditUser")),a=await $usersObj.fncs.tab.users.update(s);if(!a){const e=s.find("#rolesE");return 0==e.val().length?s.find("#err_rolesE").html('<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Información obligatoria.'):s.find("#err_rolesE").html(""),!1}return $usersObj.fncs.tab.users.refresh.tableUsers(),$usersObj.fncs.resetForm($("#frmEditUser")),!0}})},activeInactive:async function(e){e.preventDefault();const s=$("#usersTab .tableSection"),a=$(this).closest("tr"),r=JSON.parse(atob(a.data("model")));try{const{value:e}=await Swal.fire({title:"1"===r.userActive?"Desactivar":"Activar",text:`Usuario [ ${r.userName} ]`,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Aceptar",cancelButtonText:"Cancelar"});if(!e)return!1;const t=`idUser=${r.id}&action=${"1"===r.userActive?0:1}`;if($__promise=await $.genericAjaxPromise({ajax:{type:"POST",url:`${siteUrl}administrator/ajaxActiveInactive`,data:{csrf_QUERY:csrf.hash,model:t},headers:{}},loadingOverlayObj:a}).catch(function(e){return e}),!$ajaxResponse.check($__promise))throw $__promise;$usersObj.fncs.tab.users.refresh.tableUsers()}catch(e){$exception._throw(e,s)}},save:async()=>{let e=!1,s=$usersObj.vars.forms.frmAddUsers;try{if(s.closeAlert({alertType:"alert-danger"}),!s.valid())throw new Error("Formulario incompleto");const a=s.serialize();if($__promise=await $.genericAjaxPromise({ajax:{type:"POST",url:`${siteUrl}administrator/ajaxSaveuser`,data:{csrf_QUERY:csrf.hash,model:a},headers:{}},loadingOverlayObj:s}).catch(function(e){return e}),!$ajaxResponse.check($__promise))throw $__promise;s.LoadingOverlay("hide"),e=!0}catch(e){$exception._throw(e,s)}return $usersObj.vars.status.userSaved=e,e},update:async(e=null)=>{let s=!1,a=e;try{if(a.closeAlert({alertType:"alert-danger"}),!a.valid())throw new Error("Formulario incompleto");const e=$(a).serialize();if($__promise=await $.genericAjaxPromise({ajax:{type:"POST",url:`${siteUrl}administrator/ajaxUpdateUser`,data:{csrf_QUERY:csrf.hash,model:e},headers:{}},loadingOverlayObj:a}).catch(function(e){return e}),!$ajaxResponse.check($__promise))throw $__promise;a.LoadingOverlay("hide"),s=!0}catch(e){$exception._throw(e,a)}return $usersObj.vars.status.userSaved=s,s}}}},actions:{getUsers:e=>$.genericAjaxPromise({ajax:{type:"POST",url:`${siteUrl}Catalogs/ajaxUsers`,data:{csrf_QUERY:csrf.hash},headers:{}},loadingOverlayObj:e}),addPerson:async e=>{let s=null,a=e;try{if(a.closeAlert({alertType:"alert-danger"}),!a.valid())throw new Error("Formulario incompleto");const e=`nombres=${a.find("#nombres").val()}&ap1=${a.find("#ap1").val()}&ap2=${a.find("#ap2").val()}`;if($__promise=await $.genericAjaxPromise({ajax:{type:"POST",url:`${siteUrl}administrator/ajaxAddPerson`,data:{csrf_QUERY:csrf.hash,model:e},headers:{}},loadingOverlayObj:a}).catch(function(e){return e}),!$ajaxResponse.check($__promise))throw $__promise;a.LoadingOverlay("hide"),s=$__promise.data.id}catch(e){$exception._throw(e,a)}return s},addRol:async e=>{let s=null,a=e;try{if(a.closeAlert({alertType:"alert-danger"}),!a.valid())throw new Error("Formulario incompleto");const e=`tag=${a.find("#tag").val()}&rol=${a.find("#rolDescrip").val()}`;if($__promise=await $.genericAjaxPromise({ajax:{type:"POST",url:`${siteUrl}administrator/ajaxAddRol`,data:{csrf_QUERY:csrf.hash,model:e},headers:{}},loadingOverlayObj:a}).catch(function(e){return e}),!$ajaxResponse.check($__promise))throw $__promise;a.LoadingOverlay("hide"),s=$__promise.data.id}catch(e){$exception._throw(e,a)}return s}}};$(document).ready(()=>{$usersObj.fncs.init()});